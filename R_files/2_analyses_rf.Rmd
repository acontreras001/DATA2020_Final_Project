---
title: "Random Forest Analysis"
output: pdf_document
---

# Introduction
This file documents the Random Forest Analysis 

## Dependency Setup
```{r Dependency Setup, inlcude = TRUE}

if (!require("here")) install.packages("here")
library(here)

# Set current working directory to file location
setwd(here::here())

#Print current working directory in case not connected to .Rproj file
print(getwd())

# Define the path to the .renv lockfile within the 'renv' folder
renv_lockfile <- file.path(getwd(), "renv.lock")

# Activate and restore packages from renv lock file
if (!require("renv")) install.packages("renv")
renv::restore()

# Use the p_load function to install and load any desired packages that may not 
# have been in the renv.lock file. Note, if the packages were already in the 
# renv.lock file, that is okay. `p_load` will not change version number

if (!require("pacman")) install.packages("pacman")
pacman::p_load(renv, rmarkdown,  knitr, tidyverse, reshape2, stargazer, 
               haven, gridExtra, broom, car, caret, Metrics, randomForest)

# Update the renv lock file
renv::snapshot()
```

# Load the dataset

```{r}

# Load the dataset
dataset <- readr::read_csv("data/processed/EDA_output.csv")

```

# Preprocess the data

```{r}

# Preprocessing
dataset <- select(dataset, -participant_id)  # Drop the participant_id column
dataset <- na.omit(dataset)                  # Remove rows with any missing data

# Ensure the target variable is a factor
dataset$father_vote_nov2000 <- as.factor(dataset$father_vote_nov2000)

# Prepare data
response <- dataset$father_vote_nov2000
features <- select(dataset, -father_vote_nov2000)

```

# Run the Random Forest Model and Interpret Results

```{r}

# Run the random forest model
set.seed(42)  # Set seed for reproducibility
rf_model <- randomForest(response ~ ., data=features, ntree=500, importance=TRUE)

# Output
print(rf_model)  # Print the model summary
print(importance(rf_model))  # Print variable importance

# Predictions and evaluation
predictions <- predict(rf_model, dataset)

# Confusion matrix to see the prediction accuracy
conf_mat <- table(Predicted = predictions, Actual = response)

# Print the confusion matrix
print(conf_mat)

# Calculate classification error
total_predictions <- sum(conf_mat)
correct_predictions <- sum(diag(conf_mat))  # Sum of diagonal elements (correct predictions)
classification_error <- (total_predictions - correct_predictions) / total_predictions

# Print classification error
print(paste("Classification Error:", classification_error))
```

# Print out the feature importance

```{r}
importance_data <- importance(rf_model)
feature_importance <- data.frame(
  Feature = rownames(importance_data),
  Importance = importance_data[, "MeanDecreaseGini"]
)

# Create a bar plot of feature importance
p <- ggplot(feature_importance, aes(x = reorder(Feature, Importance), y = Importance)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Feature Importance in Random Forest Model",
       x = "Feature",
       y = "Importance (Gini Decrease)") +
  coord_flip() +  # Flips the axes for better visualization of long names
  theme_minimal()

output_directory <- file.path(getwd(), "outputs/analysis_rf")

# Saving each plot with a unique filename based on the variable name
ggsave(paste0(output_directory, "/random_forest_feature_importance", ".png"), plot = p, width = 10, height = 8, dpi = 300)

```

# Export the RandomForest Results as LaTeX code

```{r}

importance_data <- as.data.frame(importance(rf_model))
latex_table <- xtable(importance_data)
print(latex_table, include.rownames = TRUE, floating = FALSE)

```
