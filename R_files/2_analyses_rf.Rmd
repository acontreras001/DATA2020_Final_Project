---
title: "Random Forest Analysis"
output: pdf_document
---

# Introduction
This file documents the Random Forest Analysis 

## Dependency Setup
```{r Dependency Setup, inlcude = TRUE}

if (!require("here")) install.packages("here")
library(here)

# Set current working directory to file location
setwd(here::here())

#Print current working directory in case not connected to .Rproj file
print(getwd())

# Define the path to the .renv lockfile within the 'renv' folder
renv_lockfile <- file.path(getwd(), "renv.lock")

# Activate and restore packages from renv lock file
if (!require("renv")) install.packages("renv")
renv::restore()

# Use the p_load function to install and load any desired packages that may not 
# have been in the renv.lock file. Note, if the packages were already in the 
# renv.lock file, that is okay. `p_load` will not change version number

if (!require("pacman")) install.packages("pacman")
pacman::p_load(renv, rmarkdown,  knitr, tidyverse, reshape2, stargazer, 
               haven, gridExtra, broom, car, caret, Metrics, randomForest)

# Update the renv lock file
renv::snapshot()
```

# Load the dataset

```{r}

# Load the dataset
dataset <- readr::read_csv("data/processed/EDA_output.csv")

dataset

```

# Check that all rows are unique

```{r}
duplicates <- duplicated(dataset) | duplicated(dataset, fromLast = TRUE)

# Extract the rows that are duplicated
duplicate_rows <- dataset[duplicates, ]

# View the duplicate rows
print(duplicate_rows)

```

# Preprocess the data

```{r}

# Preprocessing
dataset <- select(dataset, -participant_id)  
dataset <- na.omit(dataset)                  

# Ensure the target variable is a factor
dataset$father_vote_nov2020 <- as.factor(dataset$father_vote_nov2020)

# Prepare data
response <- dataset$father_vote_nov2020
features <- select(dataset, -father_vote_nov2020)

```

# Run the Random Forest Model and Interpret Results

```{r}

# Run the random forest model
set.seed(42)  # Set seed for reproducibility
rf_model <- randomForest(response ~ ., data=features, ntree=500, importance=TRUE)

# Output
print(rf_model)  # Print the model summary
print(importance(rf_model))  # Print variable importance

# Predictions and evaluation
predictions <- predict(rf_model, dataset)

# Confusion matrix to see prediction accuracy
conf_mat <- table(Predicted = predictions, Actual = response)
print(conf_mat)

# Calculate classification error
total_predictions <- sum(conf_mat)
correct_predictions <- sum(diag(conf_mat)) 
classification_error <- (total_predictions - correct_predictions) / total_predictions

# Print classification error
print(paste("Classification Error:", classification_error))
```


# Random Forest with Cross Valedation

```{r}
library(caret)
# Define training control
#train_control <- trainControl(method = "cv", number = 10)  # 10-fold cross-validation

# Train the model using cross-validation
#rf_model_cv <- train(response ~ ., data=features, method="rf", 
#                     trControl=train_control, ntree=500, importance=TRUE)

# Print model summary
#print(rf_model_cv)

# Run the random forest model with OOB error estimation
rf_model <- randomForest(response ~ ., data=features, ntree=500, importance=TRUE, keep.inbag=TRUE)

# OOB error
print(rf_model$err.rate)
```


# Print out the feature importance

```{r}
importance_data <- importance(rf_model)
feature_importance <- data.frame(
  Feature = rownames(importance_data),
  Importance = importance_data[, "MeanDecreaseGini"]
)

# Define the color using RGB values
custom_color <- rgb(78/255, 54/255, 41/255)

# Create a bar plot of feature importance using the custom RGB color
p <- ggplot(feature_importance, aes(x = reorder(Feature, Importance), y = Importance)) +
  geom_bar(stat = "identity", fill = custom_color) + 
  labs(title = "Feature Importance in Random Forest Model",
       x = "Feature",
       y = "Importance (Gini Decrease)") +
  coord_flip() +  
  theme_minimal() +
  theme(axis.text.y = element_text(angle = 0, size = 16))


output_directory <- file.path(getwd(), "outputs/analysis_rf")

# Saving each plot
ggsave(paste0(output_directory, "/random_forest_feature_importance", ".png"), plot = p, width = 10, height = 8, dpi = 300)

```

# Create Plot with only top 5 most improtant features

```{r}
# Print out the feature importance

importance_data <- importance(rf_model)
feature_importance <- data.frame(
  Feature = rownames(importance_data),
  Importance = importance_data[, "MeanDecreaseGini"]
)

# Sort features by importance and select the top 5
feature_importance <- feature_importance[order(-feature_importance$Importance), ]
top_features <- head(feature_importance, 5)

# Define the color using RGB values
custom_color <- rgb(78/255, 54/255, 41/255)

# Assuming 'labels' is a vector containing the labels for the features
labels <- c("Household Income Pre-tax", "Father Age", "Mother Age", "Race Category", "Mother Voted in November 2020 Eelction")

# Create the plot
p <- ggplot(top_features, aes(x = reorder(labels, Importance), y = Importance)) +
  geom_bar(stat = "identity", fill = custom_color) + 
  labs(title = "Top 5 Feature Importance in Random Forest Model",
       x = "Feature",
       y = "Importance (Gini Decrease)") +
  coord_flip() +  
  theme_minimal() +
  theme(axis.text.y = element_text(angle = 0, size = 16))

output_directory <- file.path(getwd(), "outputs/analysis_rf")

# Saving each plot
ggsave(paste0(output_directory, "/top_5_random_forest_feature_importance", ".png"), plot = p, width = 10, height = 8, dpi = 300)


```

# Export the RandomForest Results as LaTeX code

```{r}

importance_data <- as.data.frame(importance(rf_model))
latex_table <- xtable(importance_data)
print(latex_table, include.rownames = TRUE, floating = FALSE)

```
